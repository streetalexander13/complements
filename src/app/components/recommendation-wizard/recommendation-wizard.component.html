<div class="chatbot-wizard">
<!-- Progress Bar -->
<div class="progress-container">
  <div class="progress-content">
    <div class="wizard-mobile-title">Get Your Box</div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
    <div class="progress-text">
      <span class="question-counter">{{ currentQuestion + 1 }} / {{ totalQuestions }}</span>
    </div>
  </div>
  </div>

<div *ngIf="!showReview" class="wizard-columns">
    <div class="chat-container">
      <div class="chat-messages" #chatContainer *ngIf="!showReview" [class.compact-chat]="isCompactInput()">
        
        <!-- Chat History -->
        <div *ngFor="let message of chatMessages; let i = index" class="message" 
             [class.bot-message]="message.type === 'bot'" 
             [class.user-message]="message.type === 'user'">
        
        <!-- Bot Message -->
        <div *ngIf="message.type === 'bot'" class="message-avatar">
          <div class="avatar-circle">
            <span class="material-icons">psychology</span>
          </div>
        </div>
        
        <div class="message-content">
          <div class="message-text" 
               [class.typing-animation]="i === chatMessages.length - 1 && message.type === 'bot' && !isThinking">
            {{ message.content }}
          </div>
        </div>
        
        <!-- User Message -->
        <div *ngIf="message.type === 'user'" class="message-avatar">
          <div class="avatar-circle user">
            <span class="material-icons">person</span>
          </div>
        </div>
      </div>

      <!-- Thinking Animation -->
      <div *ngIf="isThinking" class="message bot-message">
        <div class="message-avatar">
          <div class="avatar-circle">
            <span class="material-icons">psychology</span>
          </div>
        </div>
        <div class="message-content">
          <div class="thinking-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>

    </div>
      
    </div>

    <!-- Question Input Area (separate, floating footer) -->
    <div *ngIf="!showReview" 
         class="question-input fixed-footer"
         [style.minHeight.px]="isMobile() ? null : getInputMinHeight()"
         [class.overlay-input]="shouldUseOverlayInput()"
         [class.visible]="shouldUseOverlayInput() && showOverlayInput">
      <div *ngIf="shouldUseOverlayInput()" class="overlay-header">
        <h3 class="overlay-title">{{ getOverlayTitle() }}</h3>
        <button class="close-btn" (click)="closeOverlayInput()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="input-container">
        
        <!-- Text Input -->
        <div *ngIf="getCurrentQuestion()?.type === 'text'" class="input-group">
          <input 
            type="text" 
            [(ngModel)]="textInput"
            [placeholder]="getCurrentQuestion()?.placeholder || 'Enter your name'"
            class="text-input"
            (keyup.enter)="submitTextAnswer()">
          <button 
            class="send-btn"
            (click)="submitTextAnswer()"
            [disabled]="!textInput">
            <span class="material-icons">send</span>
          </button>
        </div>

        <!-- Number Input -->
        <div *ngIf="getCurrentQuestion()?.type === 'number'" class="input-group">
          <input 
            type="number" 
            [(ngModel)]="numberInput"
            [placeholder]="getCurrentQuestion()?.placeholder || 'Enter your age'"
            class="text-input"
            (keyup.enter)="submitNumberAnswer()">
          <button 
            class="send-btn"
            (click)="submitNumberAnswer()"
            [disabled]="!numberInput">
            <span class="material-icons">send</span>
          </button>
        </div>

        <!-- Radio Options -->
        <div *ngIf="getCurrentQuestion()?.type === 'radio'" class="radio-options">
          <button 
            *ngFor="let option of getCurrentQuestion()?.options" 
            class="option-btn"
            (click)="answerQuestion(option.value)">
            {{ option.label }}
          </button>
        </div>

        <!-- Sports Selection -->
        <div *ngIf="getCurrentQuestion()?.type === 'sports'" class="sports-selection">
          <div class="sport-options">
            <button 
              *ngFor="let sport of getAllSports(); let i = index" 
              class="sport-btn"
              [class.selected]="isSportSelected(sport.value)"
              (click)="answerQuestion(sport.value)"
              [style.animation-delay.ms]="i * 100">
              <span class="sport-icon material-icons">{{ sport.icon }}</span>
              <span class="sport-label">{{ sport.label }}</span>
            </button>
          </div>
          <button 
            class="continue-btn desktop-only"
            (click)="nextQuestion()"
            [disabled]="!isQuestionAnswered('sports')">
            Continue
          </button>
        </div>

        <!-- Goals Selection -->
        <div *ngIf="getCurrentQuestion()?.type === 'goals'" class="goals-selection">
          <div class="goal-ranking-container">
            <div class="goal-section">
              <h4>Available Goals</h4>
              <div class="goal-list available-goals">
                <button 
                  *ngFor="let goal of availableGoals" 
                  class="goal-btn"
                  (click)="addGoalToRanked(goal)">
                  <span class="goal-label">{{ formatGoalLabel(goal) }}</span>
                  <span class="material-icons">add</span>
                </button>
              </div>
            </div>

            <div class="goal-section">
              <h4>Your Priority Order</h4>
              <div class="goal-list ranked-goals">
                <div 
                  *ngFor="let goal of rankedGoals; let i = index" 
                  class="goal-item ranked-goal">
                  <div class="goal-content">
                    <span class="rank-number">{{ i + 1 }}</span>
                    <span class="goal-label">{{ formatGoalLabel(goal) }}</span>
                    <button 
                      type="button" 
                      class="remove-goal"
                      (click)="removeGoal(goal)">
                      <span class="material-icons">close</span>
                    </button>
                  </div>
                </div>
                <div *ngIf="rankedGoals.length === 0" class="empty-state">
                  <p>Tap goals to add them here</p>
                </div>
              </div>
            </div>
          </div>
          <button 
            class="continue-btn desktop-only"
            (click)="nextQuestion()"
            [disabled]="!isQuestionAnswered('goals')">
            Continue
          </button>
        </div>

        <!-- Fitness Level Selection -->
        <div *ngIf="getCurrentQuestion()?.type === 'fitnessLevel'" class="fitness-level-selection">
          <div class="level-grid">
            <button 
              *ngFor="let level of ['beginner', 'intermediate']" 
              class="level-btn"
              [class.selected]="wizardForm.get('fitnessLevel')?.value === level"
              (click)="answerQuestion(level)">
              <div class="level-card">
                <h3>{{ level === 'beginner' ? 'Simple' : 'Essentials' }}</h3>
                <p>{{ level === 'beginner' ? '3 products' : '4-5 products' }}</p>
                
                <!-- Show personalized supplements -->
                <div class="level-supplements">
                  <div *ngFor="let supplement of getPersonalizedSupplementsForLevel(level, buildUserProfile())" 
                       class="supplement-preview">
                    <span class="supplement-name">{{ supplement.name }}</span>
                    <span class="supplement-price">£{{ supplement.price }}</span>
                  </div>
                </div>
                
                <div class="level-price">{{ getLevelPrice(level) }}</div>
              </div>
            </button>
          </div>
        </div>

        <!-- Textarea Input -->
        <div *ngIf="getCurrentQuestion()?.type === 'textarea'" class="textarea-input-container">
          <div class="input-group">
            <textarea 
              [(ngModel)]="textareaInput"
              [placeholder]="getCurrentQuestion()?.placeholder || 'Tell us anything else we should know...'"
              class="textarea-input"
              rows="4"></textarea>
            <button 
              class="send-btn"
              (click)="submitTextareaAnswer()">
              <span class="material-icons">send</span>
            </button>
          </div>
          <div class="textarea-actions">
            <button 
              class="nothing-else-btn"
              (click)="submitNothingElse()">
              Nothing else
            </button>
          </div>
        </div>

        <!-- Overlay Trigger for Complex Inputs -->
        <div *ngIf="shouldUseOverlayInput() && !showOverlayInput" class="overlay-trigger">
          <button class="trigger-btn" (click)="toggleOverlayInput()">
            <span class="material-icons">expand_more</span>
            <span>{{ getOverlayTitle() }}</span>
          </button>
        </div>

      </div>
    </div>

    </div> <!-- /.wizard-columns -->

    <!-- Review Section -->
    <div *ngIf="showReview" class="review-section">
      <!-- Review Header -->
      <div class="review-header">
        <h2>Perfect! Choose your plan</h2>
        <p>Pick one of the three options tailored to you</p>
      </div>
      
      <!-- Three purchase options -->
      <div class="plans-grid">
        <div class="plan-card" *ngFor="let level of ['beginner','intermediate','advanced']">
          <div class="plan-header">
            <h3>{{ getLevelTitle(level) }}</h3>
            <div class="plan-price">{{ getLevelPrice(level) }}</div>
          </div>

          <div class="plan-description">{{ getLevelDescription(level) }}</div>

          <div class="plan-supplements">
            <div class="supplement-row" *ngFor="let supplement of getPersonalizedSupplementsForLevel(level, buildUserProfile()).slice(0,4)">
              <span class="supplement-name">{{ supplement.name }}</span>
              <span class="supplement-price">£{{ supplement.price }}</span>
            </div>
          </div>

          <button 
            class="subscribe-btn"
            (click)="subscribeToBoxForLevel(level)"
            [disabled]="isLoading">
            <span *ngIf="!isLoading">Choose {{ getLevelTitle(level) }}</span>
            <span *ngIf="isLoading">Setting up your box...</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="chat-navigation" [class.hidden]="showReview">
      <button 
        type="button" 
        class="nav-btn back-btn"
        (click)="previousQuestion()"
        [disabled]="currentQuestion === 0 || isThinking">
        <span class="material-icons">arrow_back</span>
        Back
      </button>
      <button 
        type="button"
        [ngClass]="{ 'skip-btn': !isCurrentAnswered(), 'continue-btn': isCurrentAnswered(), 'mobile-only': isMobile() }"
        (click)="nextQuestion()"
        [disabled]="isThinking">
        {{ isCurrentAnswered() ? 'Continue' : 'Skip' }}
      </button>
    </div>
  </div>
